// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Subscriber {
  id             String           @id @default(cuid())
  email          String           @unique
  status         SubscriberStatus @default(ACTIVE)
  createdAt      DateTime         @default(now())
  confirmedAt    DateTime?
  unsubscribedAt DateTime?
  source         String?

  deliveries Delivery[]
  events     Event[]
}

enum SubscriberStatus {
  PENDING
  ACTIVE
  UNSUBSCRIBED
  BOUNCED
}

model Issue {
  id   String @id @default(cuid())
  slug String @unique

  // Email/metadata
  title       String
  subject     String
  previewText String?

  // Story sections
  intro        String?
  whatsGoingOn String?
  whyItMatters String?
  readMore     String?

  // Classification
  category String? // ðŸ‘ˆ ADD THIS

  // Status + publishing
  status      IssueStatus @default(DRAFT)
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deliveries  Delivery[]
  socialPosts SocialPost[]
}

enum IssueStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Delivery {
  id            String         @id @default(cuid())
  issueId       String
  subscriberId  String
  status        DeliveryStatus @default(QUEUED)
  providerMsgId String?
  sentAt        DateTime?
  deliveredAt   DateTime?
  error         String?

  issue      Issue      @relation(fields: [issueId], references: [id])
  subscriber Subscriber @relation(fields: [subscriberId], references: [id])

  @@unique([issueId, subscriberId])
}

enum DeliveryStatus {
  QUEUED
  SENT
  DELIVERED
  FAILED
  BOUNCED
}

model Event {
  id           String    @id @default(cuid())
  type         EventType
  issueId      String?
  subscriberId String?
  deliveryId   String?
  url          String?
  userAgent    String?
  ip           String?
  createdAt    DateTime  @default(now())

  subscriber Subscriber? @relation(fields: [subscriberId], references: [id])
}

enum EventType {
  OPEN
  CLICK
  UNSUBSCRIBE
  BOUNCE
  COMPLAINT
}

model SocialPost {
  id       String           @id @default(cuid())
  platform SocialPlatform
  issueId  String? // link to Issue when this is an issue thread
  url      String? // optional: if posting a blog URL not tied to Issue
  status   SocialPostStatus @default(DRAFT)

  // Content
  tweetCount Int               @default(0)
  tweets     SocialPostTweet[]

  // Publishing results
  rootPostId  String? // root tweet id on X
  lastPostId  String? // last tweet id (useful for debugging)
  publishedAt DateTime?

  // Error / retries
  attempts  Int     @default(0)
  lastError String?

  // Audit
  createdBy String? // "n8n", "admin", etc.
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  issue Issue? @relation(fields: [issueId], references: [id])

  @@index([platform, status])
  @@index([issueId])
}

model SocialPostTweet {
  id           String  @id @default(cuid())
  socialPostId String
  order        Int
  text         String // final tweet text (already 280-safe and numbered)
  xPostId      String? // tweet id after publishing

  socialPost SocialPost @relation(fields: [socialPostId], references: [id], onDelete: Cascade)

  @@unique([socialPostId, order])
}

enum SocialPlatform {
  X
}

enum SocialPostStatus {
  DRAFT
  READY // generated and validated, ready to publish
  PUBLISHING
  PUBLISHED
  FAILED
}
